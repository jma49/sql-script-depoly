# .github/workflows/deploy.yml
name: Deploy Next.js App to Production

on:
  push:
    branches: [ main ]

env:
  NODE_VERSION: '20.19.3'
  APP_NAME: 'next-app'
  HEALTH_CHECK_URL: 'http://localhost:3000'
  HEALTH_CHECK_TIMEOUT: 60

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER_HOST }}
          username: ${{ secrets.DEPLOY_SERVER_USER }}
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          command_timeout: 15m
          
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            
            echo "ğŸš€ å¼€å§‹é›¶åœæœºéƒ¨ç½²..."
            
            # é¢œè‰²å®šä¹‰
            RED='\033[0;31m'
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            BLUE='\033[0;34m'
            NC='\033[0m' # No Color
            
            # æ—¥å¿—å‡½æ•°
            log_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
            log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
            log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
            log_error() { echo -e "${RED}âŒ $1${NC}"; }
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /root/sql-script-depoly || { log_error "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; exit 1; }
            
            # 1. éƒ¨ç½²å‰æ£€æŸ¥
            log_info "æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥..."
            
            # æ£€æŸ¥ç³»ç»Ÿèµ„æº
            FREE_MEM=$(free -m | awk 'NR==2{printf "%.1f", $7*100/$2}')
            DISK_USAGE=$(df -h . | awk 'NR==2{print $5}' | sed 's/%//')
            
            log_info "å¯ç”¨å†…å­˜: ${FREE_MEM}%"
            log_info "ç£ç›˜ä½¿ç”¨: ${DISK_USAGE}%"
            
            if (( $(echo "$FREE_MEM < 10" | bc -l) )); then
              log_error "å¯ç”¨å†…å­˜ä¸è¶³ (${FREE_MEM}%)ï¼Œå–æ¶ˆéƒ¨ç½²"
              exit 1
            fi
            
            if [ "$DISK_USAGE" -gt 90 ]; then
              log_error "ç£ç›˜ç©ºé—´ä¸è¶³ (${DISK_USAGE}%)ï¼Œå–æ¶ˆéƒ¨ç½²"
              exit 1
            fi
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ä¿¡æ¯
            CURRENT_COMMIT=$(git rev-parse HEAD)
            BACKUP_DIR="/tmp/deploy-backup-$(date +%Y%m%d-%H%M%S)"
            
            log_info "å½“å‰ç‰ˆæœ¬: ${CURRENT_COMMIT:0:8}"
            log_info "åˆ›å»ºå¤‡ä»½ç‚¹: $BACKUP_DIR"
            
            # 2. æ‹‰å–æ–°ä»£ç 
            log_info "æ‹‰å–æœ€æ–°ä»£ç ..."
            if ! git pull origin main; then
              log_error "Git pull å¤±è´¥"
              exit 1
            fi
            
            NEW_COMMIT=$(git rev-parse HEAD)
            log_info "æ–°ç‰ˆæœ¬: ${NEW_COMMIT:0:8}"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ–°
            if [ "$CURRENT_COMMIT" = "$NEW_COMMIT" ]; then
              log_warning "æ²¡æœ‰æ–°çš„æäº¤ï¼Œè·³è¿‡éƒ¨ç½²"
              exit 0
            fi
            
            # 3. è®¾ç½® Node.js ç¯å¢ƒ
            log_info "è®¾ç½® Node.js ç¯å¢ƒ..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ Node.js ç‰ˆæœ¬
            if ! nvm use ${{ env.NODE_VERSION }}; then
              log_warning "Node.js ${{ env.NODE_VERSION }} æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
              nvm install ${{ env.NODE_VERSION }}
              nvm use ${{ env.NODE_VERSION }}
            fi
            
            log_success "Node.js ç‰ˆæœ¬: $(node --version)"
            log_success "NPM ç‰ˆæœ¬: $(npm --version)"
            
            # 4. å®‰è£…ä¾èµ–
            log_info "å®‰è£…ä¾èµ–..."
            if ! npm ci --production=false; then
              log_error "ä¾èµ–å®‰è£…å¤±è´¥"
              exit 1
            fi
            
            # 5. æ„å»ºæ–°ç‰ˆæœ¬ï¼ˆé™ä½ä¼˜å…ˆçº§ä»¥å‡å°‘å¯¹å½“å‰æœåŠ¡çš„å½±å“ï¼‰
            log_info "æ„å»ºæ–°ç‰ˆæœ¬ï¼ˆä½ä¼˜å…ˆçº§æ¨¡å¼ï¼‰..."
            if ! nice -n 10 npm run build; then
              log_error "æ„å»ºå¤±è´¥ï¼Œå›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬"
              git reset --hard $CURRENT_COMMIT
              exit 1
            fi
            
            log_success "æ„å»ºå®Œæˆ"
            
            # 6. PM2 é›¶åœæœºéƒ¨ç½²
            log_info "å¼€å§‹é›¶åœæœºé‡è½½..."
            
            # ç¡®ä¿ PM2 å·²å®‰è£…
            if ! command -v pm2 &> /dev/null; then
              log_warning "PM2 æœªå®‰è£…ï¼Œæ­£åœ¨å…¨å±€å®‰è£…..."
              npm install -g pm2
            fi
            
                         # æ£€æŸ¥åº”ç”¨æ˜¯å¦å­˜åœ¨
             if pm2 describe ${{ env.APP_NAME }} > /dev/null 2>&1; then
               log_info "æ‰§è¡Œé›¶åœæœºé‡è½½..."
               
               # ä½¿ç”¨ ecosystem.config.js è¿›è¡Œé›¶åœæœºé‡è½½
               if ! pm2 reload ecosystem.config.js --env production; then
                 log_error "PM2 é‡è½½å¤±è´¥ï¼Œå°è¯•å›æ»š..."
                 git reset --hard $CURRENT_COMMIT
                 npm ci --production=false
                 npm run build
                 pm2 reload ecosystem.config.js --env production
                 exit 1
               fi
             else
               log_info "é¦–æ¬¡éƒ¨ç½²ï¼Œå¯åŠ¨åº”ç”¨..."
               # ä½¿ç”¨ ecosystem é…ç½®å¯åŠ¨åº”ç”¨
               pm2 start ecosystem.config.js --env production
             fi
            
            # ä¿å­˜ PM2 é…ç½®
            pm2 save
            
            # 7. å¥åº·æ£€æŸ¥
            log_info "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            
            # ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
            sleep 15
            
            # å¤šè½®å¥åº·æ£€æŸ¥
            HEALTH_CHECKS=0
            MAX_HEALTH_CHECKS=6
            HEALTH_CHECK_INTERVAL=10
            
            while [ $HEALTH_CHECKS -lt $MAX_HEALTH_CHECKS ]; do
              if curl -f --connect-timeout 10 --max-time 30 ${{ env.HEALTH_CHECK_URL }} > /dev/null 2>&1; then
                log_success "å¥åº·æ£€æŸ¥é€šè¿‡ (ç¬¬ $((HEALTH_CHECKS + 1)) æ¬¡)"
                break
              else
                HEALTH_CHECKS=$((HEALTH_CHECKS + 1))
                if [ $HEALTH_CHECKS -eq $MAX_HEALTH_CHECKS ]; then
                  log_error "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ‰§è¡Œè‡ªåŠ¨å›æ»š..."
                  
                  # è‡ªåŠ¨å›æ»š
                  git reset --hard $CURRENT_COMMIT
                  npm ci --production=false
                  npm run build
                  pm2 reload ${{ env.APP_NAME }} --update-env
                  
                  log_error "å·²å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬: ${CURRENT_COMMIT:0:8}"
                  exit 1
                else
                  log_warning "å¥åº·æ£€æŸ¥å¤±è´¥ (ç¬¬ $HEALTH_CHECKS æ¬¡)ï¼Œ${HEALTH_CHECK_INTERVAL}ç§’åé‡è¯•..."
                  sleep $HEALTH_CHECK_INTERVAL
                fi
              fi
            done
            
            # 8. éªŒè¯ PM2 çŠ¶æ€
            if pm2 describe ${{ env.APP_NAME }} | grep -q "online"; then
              INSTANCE_COUNT=$(pm2 describe ${{ env.APP_NAME }} | grep -c "online")
              log_success "åº”ç”¨è¿è¡Œæ­£å¸¸ï¼Œæ´»è·ƒå®ä¾‹: $INSTANCE_COUNT"
            else
              log_error "PM2 çŠ¶æ€å¼‚å¸¸"
              pm2 logs ${{ env.APP_NAME }} --lines 20
              exit 1
            fi
            
            # 9. æ¸…ç†æ—§çš„æ„å»ºç¼“å­˜ï¼ˆé‡Šæ”¾ç£ç›˜ç©ºé—´ï¼‰
            log_info "æ¸…ç†æ„å»ºç¼“å­˜..."
            npm run clean:cache 2>/dev/null || true
            
            # æ¸…ç†æ—§çš„ PM2 æ—¥å¿—
            pm2 flush
            
            log_success "ğŸ‰ é›¶åœæœºéƒ¨ç½²å®Œæˆï¼"
            log_info "ç‰ˆæœ¬æ›´æ–°: ${CURRENT_COMMIT:0:8} â†’ ${NEW_COMMIT:0:8}"
            log_info "éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"