# SQL è„šæœ¬éƒ¨ç½²ç³»ç»Ÿ - Scripts ç›®å½•

è¿™ä¸ªç›®å½•åŒ…å«äº† SQL è„šæœ¬éƒ¨ç½²ç³»ç»Ÿçš„æ‰€æœ‰è¿ç»´å’Œç®¡ç†è„šæœ¬ã€‚

## ğŸ“ ç›®å½•ç»“æ„

### ğŸš€ æ ¸å¿ƒæ‰§è¡Œè„šæœ¬

- `run-sql.ts` - å•ä¸ª SQL è„šæœ¬æ‰§è¡Œå™¨
- `run-all-scripts.ts` - æ‰¹é‡è„šæœ¬æ‰§è¡Œå™¨
- `types.ts` - å…¬å…±ç±»å‹å®šä¹‰

### ğŸ§¹ ç»´æŠ¤è„šæœ¬ (`maintenance/`)

- `optimize-database-indexes.ts` - æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–å’Œæ€§èƒ½ç›‘æ§

### ğŸ”’ å®‰å…¨å’Œæ€§èƒ½ (`security-and-performance/`)

- `deploy-enhanced-security-lite.ts` - å®‰å…¨å¢å¼ºå’Œæ€§èƒ½ä¼˜åŒ–éƒ¨ç½²

### ğŸ’¾ ç¼“å­˜ç®¡ç†

- `manage-cache.ts` - Redis ç¼“å­˜ç®¡ç†å·¥å…·

### ğŸ”§ æœåŠ¡ç»„ä»¶ (`services/`)

- `mongo-service.ts` - MongoDB æœåŠ¡ç®¡ç†
- `slack-service.ts` - Slack é€šçŸ¥æœåŠ¡

### âš™ï¸ æ ¸å¿ƒç»„ä»¶ (`core/`)

- `sql-executor.ts` - SQL æ‰§è¡Œæ ¸å¿ƒå¼•æ“

## ğŸ¯ å¸¸ç”¨æ“ä½œ

### æ•°æ®åº“ä¼˜åŒ–

```bash
# å®Œæ•´æ•°æ®åº“ä¼˜åŒ–
npm run optimize:db

# ä»…ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
npm run optimize:db:report

# é¢„è§ˆä¼˜åŒ–æ“ä½œ
npm run optimize:db:dry-run
```

### å®‰å…¨éƒ¨ç½²

```bash
# å®Œæ•´å®‰å…¨å’Œæ€§èƒ½éƒ¨ç½²
npm run security:deploy

# ä»…éƒ¨ç½²SQLå®‰å…¨å¢å¼º
npm run security:deploy-sql-only

# ä»…éƒ¨ç½²è¿æ¥æ± ä¼˜åŒ–
npm run security:deploy-pool-only
```

### ç¼“å­˜ç®¡ç†

```bash
# æŸ¥çœ‹ç¼“å­˜å¥åº·çŠ¶æ€
npm run cache:health

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
npm run cache:stats

# æ¸…é™¤æ‰€æœ‰ç¼“å­˜
npm run cache:clear

# ç›‘æ§ç¼“å­˜æ€§èƒ½
npm run cache:monitor
```

### SQL è„šæœ¬æ‰§è¡Œ

```bash
# æ‰§è¡Œæ‰€æœ‰è„šæœ¬
npm run sql:run-all

# æ‰§è¡Œå·²å¯ç”¨çš„è„šæœ¬
npm run sql:run-enabled

# æ‰§è¡Œå®šæ—¶è„šæœ¬
npm run sql:run-scheduled

# æ‰§è¡Œç‰¹å®šè„šæœ¬
npm run sql:run <script-name>
```

## âœ¨ ä¼˜åŒ–åŠŸèƒ½çŠ¶æ€

### âœ… å·²å®Œæˆçš„ä¼˜åŒ–

- **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–** - MongoDB å’Œ PostgreSQL ç´¢å¼•å·²ä¼˜åŒ–
- **SQL å®‰å…¨å¢å¼º** - å‚æ•°åŒ–æŸ¥è¯¢ã€æ³¨å…¥é˜²æŠ¤å·²éƒ¨ç½²
- **è¿æ¥æ± ä¼˜åŒ–** - æ™ºèƒ½è¿æ¥ç®¡ç†å’Œæ€§èƒ½ç›‘æ§å·²å¯ç”¨
- **ç¼“å­˜æœºåˆ¶** - Redis ç¼“å­˜ç­–ç•¥å’Œ Check History API ç¼“å­˜å·²å®ç°
- **æŸ¥è¯¢ä¼˜åŒ–** - Check History API èšåˆæŸ¥è¯¢å·²ä¼˜åŒ–

### ğŸ“Š æ€§èƒ½æå‡æˆæœ

- **Check History API**: 50-90%æ€§èƒ½æå‡
- **æ•°æ®åº“æŸ¥è¯¢**: å¹³å‡å“åº”æ—¶é—´é™è‡³ 200ms ä»¥ä¸‹
- **ç¼“å­˜å‘½ä¸­**: 95%+çš„ç¼“å­˜å‘½ä¸­ç‡
- **è¿æ¥æ± **: QPS è¾¾åˆ° 99+ï¼Œè¿æ¥åˆ©ç”¨ç‡ä¼˜åŒ–

## ğŸ”§ ç»´æŠ¤å»ºè®®

1. **å®šæœŸæ€§èƒ½æ£€æŸ¥**

   ```bash
   npm run optimize:db:report
   npm run cache:stats
   ```

2. **ç›‘æ§ç³»ç»Ÿå¥åº·**

   ```bash
   npm run cache:health
   npm run redis:status
   ```

3. **å®‰å…¨æ£€æŸ¥**
   ```bash
   npm run security:deploy -- --no-tests
   ```

## ğŸ“ˆ ç³»ç»ŸçŠ¶æ€

- **æ€»è„šæœ¬æ•°**: 10 ä¸ªæ ¸å¿ƒè„šæœ¬
- **ä»£ç é‡**: ~77KB
- **åŠŸèƒ½è¦†ç›–**: æ‰§è¡Œã€ç¼“å­˜ã€å®‰å…¨ã€ç›‘æ§ã€ç»´æŠ¤
- **ä¼˜åŒ–çŠ¶æ€**: ğŸŸ¢ å·²å®Œæˆå…¨é¢ä¼˜åŒ–

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œå‰è¯·å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
2. å¤§å‹æ“ä½œå»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œ
3. å®šæœŸå¤‡ä»½é‡è¦é…ç½®å’Œæ•°æ®
4. ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

## ğŸ• å®šæ—¶ä»»åŠ¡æ¶æ„

### ğŸ“‹ **åŒæ¨¡å¼æ¶æ„è¯´æ˜**

æœ¬ç³»ç»Ÿé‡‡ç”¨**èŒè´£åˆ†ç¦»**çš„åŒæ¨¡å¼å®šæ—¶ä»»åŠ¡æ¶æ„ï¼š

#### **ğŸ¤– æœ¬åœ°ç‹¬ç«‹è°ƒåº¦å™¨** (æ¨èä¸»ç”¨)

- **ä½ç½®**: `scripts/scheduler/task-scheduler.ts`
- **èŒè´£**: ä¸ªæ€§åŒ–å®šæ—¶ä»»åŠ¡çš„ä¸»è¦æ‰§è¡Œå™¨
- **ä¼˜åŠ¿**:
  - âš¡ æ”¯æŒç§’çº§ç²¾åº¦å®šæ—¶ä»»åŠ¡
  - ğŸ¯ æ¯ä¸ªè„šæœ¬ç‹¬ç«‹ cron è°ƒåº¦
  - ğŸ“Š å®æ—¶ Web API ç›‘æ§ (http://localhost:3001)
  - ğŸ”§ çµæ´»çš„æš‚åœ/æ¢å¤æ§åˆ¶

**å¯åŠ¨æ–¹å¼**:

```bash
# æ–¹å¼1: ç›´æ¥å¯åŠ¨
npm run scheduler

# æ–¹å¼2: ä½¿ç”¨å¯åŠ¨è„šæœ¬
./scripts/scheduler/start-scheduler.sh

# æ–¹å¼3: å¼€å‘æ¨¡å¼
npx ts-node scripts/scheduler/task-scheduler.ts
```

**API æ¥å£**:

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3001/health

# æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡çŠ¶æ€
curl http://localhost:3001/tasks

# æš‚åœç‰¹å®šä»»åŠ¡
curl -X POST http://localhost:3001/tasks/check-user-activity/pause

# æ¢å¤ç‰¹å®šä»»åŠ¡
curl -X POST http://localhost:3001/tasks/check-user-activity/resume

# æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡
curl -X POST http://localhost:3001/tasks/check-user-activity/execute

# é‡æ–°åŠ è½½æ‰€æœ‰ä»»åŠ¡
curl -X POST http://localhost:3001/reload
```

#### **â˜ï¸ GitHub Actions** (å¤‡ç”¨/æ‰‹åŠ¨)

- **ä½ç½®**: `.github/workflows/sql-check-cron.yml`
- **èŒè´£**: æ‰‹åŠ¨è§¦å‘å’Œå¤‡ç”¨æ‰§è¡Œ
- **ä½¿ç”¨åœºæ™¯**:
  - ğŸ†˜ æœ¬åœ°è°ƒåº¦å™¨æ•…éšœæ—¶çš„å¤‡ç”¨æ‰§è¡Œ
  - ğŸ”§ æ‰‹åŠ¨æ‰¹é‡æ‰§è¡Œæ‰€æœ‰è„šæœ¬
  - ğŸ“‹ å®šæœŸç³»ç»Ÿå¥åº·æ£€æŸ¥

**è§¦å‘æ–¹å¼**:

1. **æ‰‹åŠ¨è§¦å‘**: GitHub â†’ Actions â†’ "SQL Script Manual/Backup Job" â†’ Run workflow
2. **å¯é€‰å®šæ—¶**: æ³¨é‡Šä¸­çš„æ¯æ—¥å¤‡ç”¨æ£€æŸ¥ï¼ˆå¯æŒ‰éœ€å¯ç”¨ï¼‰

### ğŸš€ **æ¨èä½¿ç”¨ç­–ç•¥**

#### **æ—¥å¸¸ä½¿ç”¨** (æœ¬åœ°è°ƒåº¦å™¨)

```typescript
// 1. åœ¨ç•Œé¢ä¸­è®¾ç½®è„šæœ¬çš„ä¸ªæ€§åŒ–å®šæ—¶
isScheduled: true
cronSchedule: "0 8 * * *"  // æ¯å¤©èŠåŠ å“¥å‡Œæ™¨3ç‚¹

// 2. å¯åŠ¨æœ¬åœ°è°ƒåº¦å™¨
npm run scheduler

// 3. ç›‘æ§æ‰§è¡ŒçŠ¶æ€
curl http://localhost:3001/tasks
```

#### **å¤‡ç”¨/åº”æ€¥** (GitHub Actions)

```bash
# åœºæ™¯1: æœ¬åœ°è°ƒåº¦å™¨æ•…éšœï¼Œéœ€è¦ç´§æ€¥æ‰§è¡Œå®šæ—¶è„šæœ¬
# â†’ GitHub Actions â†’ Manual trigger â†’ execution_mode: "scheduled"

# åœºæ™¯2: éœ€è¦æ‰¹é‡æ‰§è¡Œæ‰€æœ‰è„šæœ¬è¿›è¡Œå…¨é¢æ£€æŸ¥
# â†’ GitHub Actions â†’ Manual trigger â†’ execution_mode: "all"

# åœºæ™¯3: æµ‹è¯•æ–°éƒ¨ç½²çš„è„šæœ¬
# â†’ GitHub Actions â†’ Manual trigger â†’ debug_mode: true
```

### âš–ï¸ **å¯¹æ¯”é€‰æ‹©**

| ä½¿ç”¨åœºæ™¯               | æ¨èæ–¹å¼          | åŸå›                         |
| ---------------------- | ----------------- | --------------------------- |
| **ä¸ªæ€§åŒ–å®šæ—¶ä»»åŠ¡**     | ğŸ¤– æœ¬åœ°è°ƒåº¦å™¨     | æ”¯æŒç‹¬ç«‹ cronï¼Œç²¾ç¡®æ—¶é—´æ§åˆ¶ |
| **é«˜é¢‘æ‰§è¡Œ** (<1 å°æ—¶) | ğŸ¤– æœ¬åœ°è°ƒåº¦å™¨     | ä¸å— GitHub é™åˆ¶ï¼Œç§’çº§ç²¾åº¦  |
| **ç”Ÿäº§ç¯å¢ƒç›‘æ§**       | ğŸ¤– æœ¬åœ°è°ƒåº¦å™¨     | å®æ—¶çŠ¶æ€ï¼ŒAPI æ§åˆ¶          |
| **åº”æ€¥å¤‡ç”¨æ‰§è¡Œ**       | â˜ï¸ GitHub Actions | æ— éœ€æœ¬åœ°ç¯å¢ƒï¼Œå¯é æ€§é«˜      |
| **æ‰¹é‡ä¸€æ¬¡æ€§æ“ä½œ**     | â˜ï¸ GitHub Actions | æ‰‹åŠ¨æ§åˆ¶ï¼Œå®Œæ•´æ—¥å¿—          |
| **æ–°ç¯å¢ƒæµ‹è¯•**         | â˜ï¸ GitHub Actions | éš”ç¦»ç¯å¢ƒï¼Œå®‰å…¨æµ‹è¯•          |

### ğŸ“Š **ç›‘æ§å’Œç®¡ç†**

#### **æœ¬åœ°è°ƒåº¦å™¨ç›‘æ§**:

```bash
# å®æ—¶ä»»åŠ¡çŠ¶æ€
watch -n 5 'curl -s http://localhost:3001/tasks | jq .'

# å¥åº·æ£€æŸ¥
curl http://localhost:3001/health | jq .
```

#### **GitHub Actions ç›‘æ§**:

- GitHub â†’ Actions â†’ Workflow runs
- å®Œæ•´æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯è¿½è¸ª
- Email é€šçŸ¥ï¼ˆå¯é…ç½®ï¼‰

### ğŸ”§ **æ•…éšœå¤„ç†**

#### **æœ¬åœ°è°ƒåº¦å™¨æ•…éšœ**:

1. æ£€æŸ¥è¿›ç¨‹çŠ¶æ€: `ps aux | grep task-scheduler`
2. æŸ¥çœ‹æ—¥å¿—: `tail -f logs/scheduler.log`
3. é‡å¯æœåŠ¡: `./scripts/scheduler/start-scheduler.sh`
4. ä¸´æ—¶å¤‡ç”¨: æ‰‹åŠ¨è§¦å‘ GitHub Actions

#### **GitHub Actions æ•…éšœ**:

1. æ£€æŸ¥ Secrets é…ç½®
2. æŸ¥çœ‹ Actions è¿è¡Œæ—¥å¿—
3. ä½¿ç”¨æœ¬åœ°è°ƒåº¦å™¨ä½œä¸ºä¸»è¦æ–¹å¼

### ğŸ“ **è¿ç§»è¯´æ˜**

å¦‚æœä»æ—§çš„å•ä¸€ GitHub Actions æ¨¡å¼è¿ç§»ï¼š

1. **å¯åŠ¨æœ¬åœ°è°ƒåº¦å™¨**: `npm run scheduler`
2. **éªŒè¯ä»»åŠ¡åŠ è½½**: `curl http://localhost:3001/tasks`
3. **è§‚å¯Ÿæ‰§è¡Œæƒ…å†µ**: ç›‘æ§å‡ ä¸ªå‘¨æœŸ
4. **å¯é€‰å¤‡ç”¨ä¿æŠ¤**: åœ¨ GitHub Actions ä¸­å¯ç”¨æ³¨é‡Šçš„æ¯æ—¥æ£€æŸ¥

è¿™ç§æ¶æ„æ—¢ä¿è¯äº†çµæ´»æ€§ï¼Œåˆæä¾›äº†å¯é çš„å¤‡ç”¨æœºåˆ¶ã€‚
